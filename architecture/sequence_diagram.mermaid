sequenceDiagram
    participant User
    participant Orch as Orchestrator
    participant DA as DocumentAgent
    participant WSA as WebSearchAgent
    participant LTA as LinkTrackingAgent
    participant CSA as CodeSearchAgent
    participant SRA as SelfReflectionAgent
    participant MM as MemoryManager
    participant UPM as UserProfileManager
    participant VDB as VectorDatabase
    participant SQLDB as SQLDatabase

    %% Initial System Setup
    Note over Orch: System Initialization
    Orch->>MM: __init__(vectorStore, sqlStore)
    MM->>VDB: __init__(connectionString)
    MM->>SQLDB: __init__(connectionString)
    Orch->>UPM: __init__(memoryManager)
    Orch->>DA: __init__(documentProcessor)
    Orch->>WSA: __init__(webSearcher)
    Orch->>LTA: __init__(linkTracker)
    Orch->>CSA: __init__(codeSearcher)
    Orch->>SRA: __init__(memoryManager)

    %% Main User Interaction Flow
    User->>Orch: Submit research query
    Orch->>UPM: get_profile(userId)
    UPM->>MM: get_user_history(userId, limit)
    MM->>SQLDB: retrieve_data("user_profiles", {"userId": userId}, 1)
    SQLDB-->>MM: User profile data
    MM-->>UPM: User history
    UPM-->>Orch: UserProfile object

    %% Task Creation and Delegation
    Orch->>Orch: Create Task objects based on query and profile
    Orch->>WSA: delegate_task(webSearchTask, "web_search")
    WSA->>WSA: can_handle(webSearchTask)
    WSA->>WSA: search_web(query)
    WSA-->>Orch: WebSearch results

    %% Document Processing if needed
    alt Document processing required
        Orch->>DA: delegate_task(documentTask, "document")
        DA->>DA: can_handle(documentTask)
        DA->>DA: summarize_document(document)
        DA->>MM: store_research_item(summarizedDoc)
        MM->>VDB: store_vector(id, vector, metadata)
        VDB-->>MM: storage confirmation
        DA-->>Orch: Document summary
    end

    %% Code Search if relevant
    alt Code search required
        Orch->>CSA: delegate_task(codeTask, "code")
        CSA->>CSA: can_handle(codeTask)
        CSA->>CSA: search_code(query, language)
        CSA-->>Orch: Code snippets
    end

    %% Result Aggregation
    Orch->>Orch: collect_and_synthesize_results(responses)
    Orch-->>User: Present research response

    %% Link Tracking when user clicks
    User->>LTA: User clicks on link
    LTA->>LTA: track_link_click(link, context)
    LTA->>MM: store_user_interaction(linkInteraction)
    MM->>SQLDB: store_structured_data("interactions", linkData)
    SQLDB-->>MM: storage confirmation

    %% End of Session and Self-Reflection
    User->>Orch: End research session
    Orch->>SRA: delegate_task(reflectionTask, "reflection")
    SRA->>MM: get_user_history(userId, limit)
    MM->>SQLDB: retrieve_data("interactions", {"userId": userId}, limit)
    SQLDB-->>MM: Recent interactions
    MM-->>SRA: User history
    SRA->>SRA: reflect_on_session(sessionData)
    SRA->>MM: update_memory_with_reflection(reflection)
    MM->>VDB: store_vector(id, reflectionVector, metadata)
    VDB-->>MM: storage confirmation
    SRA->>UPM: update_profile(userId, reflectionUpdates)
    UPM->>MM: update_data("user_profiles", userId, updates)
    MM->>SQLDB: update_data("user_profiles", userId, updates)
    SQLDB-->>MM: update confirmation
    MM-->>UPM: update confirmation
    UPM-->>SRA: update confirmation
    SRA-->>Orch: Reflection complete

    %% New Session with learned preferences
    Note over User,Orch: Later: New Research Session
    User->>Orch: Submit new research query
    Orch->>UPM: get_profile(userId)
    UPM->>MM: get_user_history(userId, limit)
    MM->>SQLDB: retrieve_data("user_profiles", {"userId": userId}, 1)
    SQLDB-->>MM: Updated user profile with learned preferences
    MM-->>UPM: Updated user history
    UPM-->>Orch: Enhanced UserProfile with learned preferences
    Orch->>Orch: Create personalized tasks based on enhanced profile
    Orch->>MM: retrieve_similar_items(query, limit)
    MM->>VDB: search_similar(queryVector, limit)
    VDB-->>MM: Similar past research items
    MM-->>Orch: Relevant past research
    Orch-->>User: Present personalized research response